----------------------------------
TP02 - Automatización y scripting 
FAI - TUASSL - Variables/parámetros, 
ambiente, condiciones, listas y repetitivas. 
----------------------------------

Los ejercicios a continuación están relacionados a los temas 
de variables, parámetros posicionales, variables de ambiente, 
condiciones y listas. 

MANUAL DE REFERENCIA: "BEGINNING LINUX PROGRAMMING"
Manual en línea de bash: SECCIÓN "PARAMETERS" (PARÁMETROS)


VIM TIPS: 
---------------------------------
En modo normal: 
:set number  <- muestra los números de línea
:syntax enable <- colorea el código siguiendo la sintaxis 
:n1,n2w archivo <- escribe desde la línea n1 hasta n2 en un archivo 
:r archivo <- copia el contenido de archivo en el documento 
              actual, a partir de la posición del cursor
:vsplit archivo <- visualiza dos archivos con división vertical
	        Ctrl+w para cambiar de archivo
!!comando <- copia la salida de comando dentro del archivo actual 
:n1,n2y <- Copiar lineas n1 a n2, luego p para
           pegar donde crea conveniente.

BACKGROUND ACERCA DE CONDICIONES: 
---------------------------------
Las condiciones evaluadas con test o [[ caen en tres categorías 
principales: 
	1) comparaciones de cadenas
	2) comparaciones aritméticas
	3) condiciones sobre archivos
        4) condiciones sobre variables (nueva categoría)

Cuando en los ejercicios se pregunta de "qué tipo es la condición", se 
refiere a en cuál de estas categorías se incluye la misma. 

Ver "CONDITIONAL EXPRESSIONS" en man bash inglés ("EXPRESIONES CONDICIONALES"
en man bash en español) y páginas 31 a 33 del manual de referencia. 

ACLARACIONES GENERALES
---------------------------------
* Cuando los ejercicios pidan modificar código, repita
el bloque a continuación del original y haga las modificaciones.  

* Este práctico contiene scripts que pueden no ser comprendidos en 
su totalidad en un principio, no se preocupe, haga su mejor intento y 
enfóquese en la consigna, todo será revelado a su tiempo. 


EJERCITACIÓN:
---------------------------------
1. ¿Cómo obtiene ayuda para saber cómo interpretar o escribir 
una sentencia if, for, while, until, case o una función? Escriba 
a continuación la sintaxis y _sólo la sintaxis_ de cada una de las
estructuras de control mencionadas.  

Ejemplo: 
if: if ÓRDENES; then ÓRDENES; [ elif ÓRDENES; then ÓRDENES; ]...[ else ÓRDENES; ] fi


2. LEA PÁGINAS 31 A 36 DEL MANUAL DE REFERENCIA, LUEGO
Ejecute y explique estos casos :

Caso a)

    [[ -d /var ]]
    echo $?

    test -d /var
    echo $?

    /usr/bin/test -d /var
    echo $?


Caso b)

    [[ -d /directorio ]]
    echo $?

    test -d /directorio
    echo $?

    /usr/bin/test -d /directorio
    echo $?
    
Caso c)

    if [[ -d /var ]] ; then
	    echo "El dir existe"
    else
	    echo "NO existe"
    fi


Caso d)

    if test -d /var  ; then
	    echo "El dir existe"
    else
	    echo "NO existe"
    fi


Caso e)

    if test -d /var && [[ -d /etc ]] ; then
	    echo "Los dos directorios existen "
    else
	    echo "Alguno NO existe"
    fi


Caso f)

    if test -d /var && test -d /directorio ; then
	    echo "Los dos directorios existen "
    else
	    echo "Alguno NO existe"
    fi

3. ¿De dónde provienen las variables de ambiente que están definidas al 
   comenzar la ejecución de un script? 
   Ayuda en man bash:
          *Sección INVOCATION 
          *Subsección "Shell Variables" ("Variables del shell").  

4. 
   a)  
   Lea las páginas 29 y 30 del manual de referencia y, desarrolle
   un script que muestre el contenido de cada una de las variables
   listadas en la tabla; en caso de ser posible, modifique su contenido, 
   y vuelva a mostrar para observar el efecto. 

   b) 
   Observe el script a continuación y complete los incisos: 
     i) ¿Cuál es la función del script?  
     ii) ¿Cómo debe invocar al script para cada variable? ¿Es necesario
         utilizar comillas?¿Cuáles?¿Por qué?
     ii) Agregue una opción que si el argumento es -h muestre ayuda 
         acerca de cómo invocar el script. 
     iv) ¿Qué sucede si se lo invoca de las siguientes maneras? 
         $ ./script.sh \@ a b c 
         $ ./script.sh \# a b c 
         Explique el resultado en cada caso 
     v) Agregue una opción para poder evaluar el metacaracter * y 
        PPID. Verifique el funcionamiento para ambos.  
   
#!/bin/bash 

eval var='$'$1

case $1 in
  '#')  echo El número de parámetros posicionales es $var ;;
  '@')  echo Los parámetros posicionales son: $var ;;
  '$')  echo El PID del script actual es: $var;;
  PATH) echo Los directorios de búsqueda de binarios son: $var;;
  HOME) echo El directorio de inicio es: $var;;
  PWD)  echo El directorio de trabajo actual es: $var;;
  *)    echo El valor de la variable $1 es $var;;
esac
 
5. a) Explique los distintos métodos para ejecutar un script. En cada caso
      indique qué condiciones son necesarias para que la ejecución sea 
      exitosa (permisos de ejecución, ruta, variables de entorno, etc): 
      i) ./script.sh 
      ii) /home/usuario/bin/script.sh
      iii) script.sh
      iv) bash script.sh 
      v) . script.sh 
   b) Para cada inciso anterior verifique a través de las variables especiales 
      $$ y $PPID si se crea un nuevo proceso o no.  

6. Lea el script a continuación y complete los incisos listados: 
  a) Documente el uso de variables y parámetros posicionales. Indique 
  tipo de variables/parámetros, localidad.
  b) Agregue las sentencia declare o local para cada variable. 
  c) Observe y documente el uso de las variables de ambiente listadas en la 
  tabla de la página 29, que están en uso dentro del script.  
  d) ¿Qué condición se evalúa en el if? ¿De qué tipo es? 
  e) Reescriba la condición de if utilizando el estado de retorno de 
  algún comando en lugar de test. 

#Inicio
#####################
#!/bin/bash

logfile=/tmp/users.log
echo COMIENZO > $logfile

while true; do
     for usr in $(cut -f1 -d:  /etc/passwd);do 
	  procs=$(ps -u ${usr} --no-headers |wc -l)
	  if [[ $procs -ne 0 ]];then 
	    echo ${usr}: $procs
	  fi 
     done | sort -n -k2  
     date
     sleep 30
done >> $logfile

exit 0
# Fin del script


7. Lea el script a continuación y complete los incisos listados: 
  a)  Documente el uso de variables y parámetros posicionales. Indique 
  tipo de variables/parámetros, localidad.
  b) Observe y documente el uso de las variables de ambiente listadas en la 
  tabla de la página 29, que están en uso en el script.  
  c) ¿Se utiliza alguna otra variable de ambiente no documentada en la tabla?
  d) ¿Qué condiciones se evalúan en el script? ¿De qué tipo son? 
  ¿Puede escribirla de otra forma? 
  e) Lea páginas 43,44 y 45 del manual de referencia. Explique el funcionamiento
  de las listas observadas en el script. 

#Inicio
#####################
#!/bin/bash
[[ `id -u` -ne 0 ]] || exit

until [[ $# -eq 0 ]]; do
   if [ -d $1 ];then 
      cd $1
      for i in `ls *jpg`;do
	cp $i ${i%%jpg}JPG
      done
      cd $OLDPWD
      shift 
   fi 
done 

8. Lea el script findshell (PEDCO) y complete los incisos listados: 
  a) Documente el uso de variables y parámetros posicionales. Indique 
  tipo de variables/parámetros, localidad.
  b) ¿Cuál es el efecto de la sentencia "declare -u resp" ¿Qué sucede 
  si no se declara de ese tipo? ¿Agregaría alguna sentencia declare o local?
  c) ¿La función recibe argumentos? Modifique el script para que muestre los 
  parámetros posicionales al principio y fin de la ejecución del script y 
  dentro de la función. Ejecute el script pasando al menos dos paquetes 
  como argumento. Documente el resultado observado.  
  d) Observe y documente el uso de las variables de ambiente listadas en la 
  tabla de la página 29, que están en uso en el script.
  e) ¿Qué condiciones se evalúan en el script? ¿De qué tipo son? 
  ¿Puede escribirla de otra forma? 
  f) Lea páginas 43,44 y 45 del manual de referencia. Explique el funcionamiento
  de las listas observadas en el script. 
  
9. Lea el script a continuación y complete los incisos listados: 
  a)  Documente el uso de variables y parámetros posicionales. Indique 
  tipo de variables/parámetros, localidad.
  b) ¿Qué sucede con el valor de la variable "nota" si se le asigna algo 
  distinto de número? 
  c) ¿Agregaría alguna sentencia declare o local?
  d) ¿La función recibe argumentos? Modifique el script para que muestre los 
  parámetros posicionales al principio y fin de la ejecución del script y 
  dentro de la función. Ejecute el script cargando al menos dos alumnos y 
  documente el resultado observado. 
  e) Observe y documente el uso de las variables de ambiente listadas en la 
  tabla de la página 29, que están en uso en el script.
  f) ¿Qué condiciones se evalúan en el script? ¿De qué tipo son? 
  ¿Puede escribirla de otra forma? 
  g) Lea páginas 43,44 y 45 del manual de referencias. Explique el 
  funcionamiento de las listas observadas en el script. 

#Inicio
#####################
#!/bin/bash

declare -i nota 
declare -u nombre 
declare -u apellido 
declare -u resp

temp=`tempfile` || temp=/tmp/listado.$$

function calificar (){
	echo -n "Nombre: $1, Apellido: $2," 
	if [[ $3 -lt 4 ]];then 
	   echo " DESAPROBADO"
	else
           echo " APROBADO"
	fi   
}

while true; do
	echo -n "Por favor ingrese Nombre: " 
	read nombre
	echo -n "Por favor ingrese Apellido: " 
	read apellido
	echo -n "Nota correspondiente a $nombre $apellido: " 
	read nota
	calificar $nombre $apellido $nota >> $temp
        
	resp="N"
	while [[ "$resp" != "S" ]];do 	
	  echo -n "¿Otro ingreso? S/N": 
	  read resp 
          if [[ "$resp" == "N" ]];then 
		break 2 
	  fi 
          echo
        done 	
done
cat $temp

rm $temp 
exit 0
# Fin del script

10. Complete el siguiente script (observar etiqueta TODO) y tenga presente que 
    debe cumplir los siguientes requerimientos de funcionalidad.

    REQUERIMIENTOS:
    10.1. La longitud de la clave debe ser igual o mayor a 8 caracteres.
    10.2. La clave debe contener letras mayúsculas y minúsculas.
    10.3. Debe imprimir por pantalla el resultado de la evaluación según 
          corresponda.

OBS: ¡No olvide probar bien su script verificando que cada camino posible 
     funcione correctamente!

SCRIPT:

#Inicio
#####################
// TODO
echo "Ingrese su clave:"
read password
len="${#password}" // Explique con sus palabras qué sucede en esta línea, 
                      ayuda: sección EXPANSION man bash 

if [[ //TODO ]] ; then
   if echo "$password" | grep -q [0-9] >/dev/null; then
      if //TODO ; then
         if //TODO ; then
           //TODO
         else
           //TODO
         fi
      else
          //TODO
      fi
   else
     //TODO
   fi
else
   //TODO
fi


11. La empresa donde trabajamos necesita enviar una carta de notificación a 
    todos sus clientes. Por lo que se nos solicita crear un script para 
    automatizar la personalización de la carta, de manera que esté dirigida a 
    cada cliente. Para ello, contamos con un archivo que contiene el listado de
    todos los clientes de la empresa y, por otra parte otro archivo que contiene
    la carta de notificación (plantilla).

    11.1 Cree un archivo de texto que se llame listadoClientes.txt con la 
         siguiente información:

    Horacio Perez
    Juan José López
    Roberto Lorenzo
    Mirtha Pasturiza

    11.2 Tenga en cuenta el siguiente texto para armar el template de 
         notificación:

Estimado xxxxx, 

    Por medio de la presente me permito informarle que nuestras oficinas de 
atención al cliente se encontraran cerradas desde el 01/01/2020 al 31/01/2020 
correspondiente al período vacacional. 
    Por urgencias deberá comunicarse a nuestro centro de ayuda en el horario 
de 8 a 21 hrs., al teléfono 555-3322. 

    Sin otro particular lo saludo atte. 

Dirección de logística BBQ 

    11.3 Ud deberá crear dos shell script, el primero carta.sh contendrá la 
        lógica que permita recorrer el archivo de clientes y por cada cliente 
        invocará, creando un subshell, a cartaCustom.sh que recibirá por 
        parámetro posicional el cliente y modificará el template de la carta 
        generando un archivo personalizado. Para finalmente guardar cada 
        archivo dentro del directorio "cartas". 

Por lo tanto, la salida de la ejecución debería ser como el siguiente ejemplo:
cartas/Horacio Perez.txt
cartas/Juan josé López.txt
.... y así con cada cliente.
El contenido de cada archivo deberá tener al nombre COMPLETO de cada cliente.
 
AYUDA: Use parámetros posicionales y la repetitiva while para lectura de 
       archivos.
